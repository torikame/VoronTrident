######################################################################
# enclosure_leds.cfg
# Phase 1 Enclosure Neopixel setup:
#   1) Global printer state lighting (idle/heating/printing/paused/error)
#   2) Heat soak indication (chamber temp if available, else "heating" scene)
#   3) End-of-print presentation scene
#
# Your LED definition (already in printer.cfg):
# [neopixel enclosure]
# pin: PE6
# chain_count: 50
# color_order: GRB
######################################################################

[gcode_macro _ENC_LED_SET_ALL]
description: Internal helper to set all enclosure LEDs
gcode:
    {% set R = params.R|default(0)|float %}
    {% set G = params.G|default(0)|float %}
    {% set B = params.B|default(0)|float %}
    {% set TRANSMIT = params.TRANSMIT|default(1)|int %}
    # index in Klipper neopixel is 1-based
    {% for i in range(1, 51) %}
        {% set t = TRANSMIT if loop.last else 0 %}
        SET_LED LED=enclosure RED={R} GREEN={G} BLUE={B} INDEX={i} TRANSMIT={t}
    {% endfor %}

[gcode_macro ENC_IDLE]
description: Enclosure LEDs - idle (dim blue)
gcode:
    _ENC_LED_SET_ALL R=0.00 G=0.00 B=0.12

[gcode_macro ENC_HEATING]
description: Enclosure LEDs - heating / heat soak (amber)
gcode:
    _ENC_LED_SET_ALL R=0.18 G=0.06 B=0.00

[gcode_macro ENC_PRINTING]
description: Enclosure LEDs - printing (green)
gcode:
    _ENC_LED_SET_ALL R=0.00 G=0.16 B=0.00

[gcode_macro ENC_PAUSED]
description: Enclosure LEDs - paused (red)
gcode:
    _ENC_LED_SET_ALL R=0.18 G=0.00 B=0.00

[gcode_macro ENC_ERROR]
description: Enclosure LEDs - error/cancel (bright red)
gcode:
    _ENC_LED_SET_ALL R=0.45 G=0.00 B=0.00

[gcode_macro ENC_PRESENT]
description: Enclosure LEDs - print complete (warm white-ish)
gcode:
    # GRB strip (no white channel), simulate warm white
    _ENC_LED_SET_ALL R=0.22 G=0.18 B=0.10


######################################################################
# Heat soak indication using chamber temp (if sensor exists)
# Call: ENC_CHAMBER_STATUS TARGET=45
######################################################################

[gcode_macro ENC_CHAMBER_STATUS]
description: Set enclosure LEDs based on chamber temp vs target
gcode:
    {% set TARGET = params.TARGET|default(45)|float %}
    {% if printer["temperature_sensor chamber"] is defined %}
        {% set T = printer["temperature_sensor chamber"].temperature|float %}
        {% set ratio = (T / TARGET) if TARGET > 0 else 0 %}
        {% if ratio < 0.66 %}
            _ENC_LED_SET_ALL R=0.00 G=0.00 B=0.14
        {% elif ratio < 0.95 %}
            _ENC_LED_SET_ALL R=0.18 G=0.06 B=0.00
        {% else %}
            _ENC_LED_SET_ALL R=0.20 G=0.00 B=0.00
        {% endif %}
    {% else %}
        ENC_HEATING
    {% endif %}
