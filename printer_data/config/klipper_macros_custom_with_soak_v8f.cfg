######################################################################
# klipper_macros_custom_with_soak_v8e.cfg  (Klipper-safe Jinja)
#
# Fixes template parse errors by:
# - Removing Jinja filters with args (no round(1), no format())
# - Removing unsupported "{% break %}" usage
# - Avoiding dynamic printer[...] lookups with variable keys
#
# Features:
# - Nevermore (PB5) speed tied to CHAMBER temp via a delayed_gcode loop
# - HEATSOAK waits for chamber temp (with timeout), no timer-only soak
# - CHECK_FILAMENT_PATH expects sensors named:
#     [filament_switch_sensor filament_entry]
#     [filament_switch_sensor filament_toolhead]
######################################################################

######################################################################
# NEVERMORE FAN (SKR2 PB5)
######################################################################

[fan_generic nevermore]
pin: PB5
kick_start_time: 0.5

[gcode_macro _NEVERMORE_VARS]
variable_threshold_bed: 90      # hot-bed => enable nevermore logic
variable_target_c: 45.0         # chamber target for ABS/ASA
variable_deadband_c: 1.0        # +/- deadband
variable_min_speed: 0.20
variable_max_speed: 0.85
variable_base_speed: 0.35
variable_gain: 0.03
variable_loop_seconds: 10
gcode:

[gcode_macro NEVERMORE_OFF]
gcode:
    UPDATE_DELAYED_GCODE ID=NEVERMORE_CHAMBER_LOOP DURATION=0
    SET_FAN_SPEED FAN=nevermore SPEED=0

[gcode_macro NEVERMORE_CHAMBER_ON]
gcode:
    UPDATE_DELAYED_GCODE ID=NEVERMORE_CHAMBER_LOOP DURATION=1

[delayed_gcode NEVERMORE_CHAMBER_LOOP]
gcode:
    {% set thr_bed = printer["gcode_macro _NEVERMORE_VARS"].threshold_bed|float %}
    {% set base = printer["gcode_macro _NEVERMORE_VARS"].base_speed|float %}
    {% set gain = printer["gcode_macro _NEVERMORE_VARS"].gain|float %}
    {% set tset = printer["gcode_macro _NEVERMORE_VARS"].target_c|float %}
    {% set db = printer["gcode_macro _NEVERMORE_VARS"].deadband_c|float %}
    {% set vmin = printer["gcode_macro _NEVERMORE_VARS"].min_speed|float %}
    {% set vmax = printer["gcode_macro _NEVERMORE_VARS"].max_speed|float %}
    {% set loop_s = printer["gcode_macro _NEVERMORE_VARS"].loop_seconds|int %}

    # Only run if we're in a hot-bed job
    {% if printer.heater_bed.target|float < thr_bed %}
        SET_FAN_SPEED FAN=nevermore SPEED=0
        RESPOND PREFIX="TRACE" MSG="NEVERMORE_LOOP: bed target < threshold; nevermore off"
        UPDATE_DELAYED_GCODE ID=NEVERMORE_CHAMBER_LOOP DURATION=0
    {% else %}
        # Require a chamber temp sensor named exactly: [temperature_sensor chamber]
        {% if printer["temperature_sensor chamber"] is not defined %}
            SET_FAN_SPEED FAN=nevermore SPEED=0
            RESPOND PREFIX="TRACE" MSG="NEVERMORE_LOOP: chamber sensor missing; nevermore off"
            UPDATE_DELAYED_GCODE ID=NEVERMORE_CHAMBER_LOOP DURATION=0
        {% else %}
            {% set chamber = printer["temperature_sensor chamber"].temperature|float %}
            {% set err = (tset - chamber) %}
            {% if err|abs < db %}
                {% set err = 0.0 %}
            {% endif %}
            {% set spd = base + (err * gain) %}
            {% if spd < vmin %}{% set spd = vmin %}{% endif %}
            {% if spd > vmax %}{% set spd = vmax %}{% endif %}

            # Make short, template-safe numbers (no round() filter args)
            {% set chamber_1 = ((chamber * 10)|int) / 10.0 %}
            {% set tset_1 = ((tset * 10)|int) / 10.0 %}
            {% set spd_2 = ((spd * 100)|int) / 100.0 %}

            SET_FAN_SPEED FAN=nevermore SPEED={spd}
            RESPOND PREFIX="TRACE" MSG="NEVERMORE_LOOP: chamber={chamber_1}C target={tset_1}C speed={spd_2}"

            UPDATE_DELAYED_GCODE ID=NEVERMORE_CHAMBER_LOOP DURATION={loop_s}
        {% endif %}
    {% endif %}

######################################################################
# LOGGING HELPER
######################################################################

[gcode_macro _LOG]
gcode:
    {% set MSG = params.MSG|default("")|string %}
    {% set DISPLAY = params.DISPLAY|default(0)|int %}
    RESPOND PREFIX="TRACE" MSG="{MSG}"
    {% if DISPLAY == 1 %}
        M117 {MSG}
    {% endif %}

######################################################################
# FILAMENT PATH CHECK
######################################################################

[gcode_macro CHECK_FILAMENT_PATH]
gcode:
    {% if printer["filament_switch_sensor filament_entry"] is not defined
          or printer["filament_switch_sensor filament_toolhead"] is not defined %}
        _LOG MSG="CHECK_FILAMENT_PATH: sensors not defined; skipping" DISPLAY=0
    {% else %}
        {% set entry = printer["filament_switch_sensor filament_entry"].filament_detected %}
        {% set th    = printer["filament_switch_sensor filament_toolhead"].filament_detected %}

        {% if entry and th %}
            _LOG MSG="CHECK_FILAMENT_PATH: OK (entry+toolhead)" DISPLAY=0
        {% elif entry and not th %}
            _LOG MSG="CHECK_FILAMENT_PATH: entry=YES toolhead=NO" DISPLAY=1
            PAUSE
        {% elif not entry and th %}
            _LOG MSG="CHECK_FILAMENT_PATH: entry=NO toolhead=YES" DISPLAY=1
            PAUSE
        {% else %}
            _LOG MSG="CHECK_FILAMENT_PATH: no filament detected" DISPLAY=1
            PAUSE
        {% endif %}
    {% endif %}

######################################################################
# CHAMBER-TEMP HEATSOAK (timeout)
######################################################################

[gcode_macro HEATSOAK]
gcode:
    {% set BED = params.BED|default(110)|float %}
    {% set CHAMBER = params.CHAMBER|default(printer["gcode_macro _NEVERMORE_VARS"].target_c)|float %}
    {% set TIMEOUT = params.TIMEOUT|default(1800)|int %}   # seconds
    {% set STEP = params.STEP|default(10)|int %}           # seconds/check
    {% set thr = printer["gcode_macro _NEVERMORE_VARS"].threshold_bed|float %}

    {% if printer["gcode_macro ENC_HEATING"] is defined %} ENC_HEATING {% endif %}
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}

    {% if BED >= thr %}
        NEVERMORE_CHAMBER_ON
    {% else %}
        NEVERMORE_OFF
    {% endif %}

    M140 S{BED}
    M190 S{BED}

    {% if printer["temperature_sensor chamber"] is not defined %}
        _LOG MSG="HEATSOAK: chamber sensor missing; waiting TIMEOUT seconds" DISPLAY=1
        G4 P{TIMEOUT * 1000}
    {% else %}
        {% set loops = (TIMEOUT // STEP)|int %}
        {% set reached = 0 %}
        {% for i in range(loops) %}
            {% set t = printer["temperature_sensor chamber"].temperature|float %}
            {% if reached == 0 and t >= CHAMBER %}
                {% set reached = 1 %}
                _LOG MSG="HEATSOAK: chamber reached" DISPLAY=0
            {% endif %}

            # If not reached yet, keep waiting
            {% if reached == 0 %}
                # progress log every ~60s
                {% if (i % (60 // STEP)) == 0 %}
                    {% set t1 = ((t * 10)|int) / 10.0 %}
                    {% set c1 = ((CHAMBER * 10)|int) / 10.0 %}
                    _LOG MSG="HEATSOAK: chamber={t1}C / {c1}C" DISPLAY=0
                {% endif %}
                G4 P{STEP * 1000}
            {% endif %}
        {% endfor %}

        {% if reached == 0 %}
            {% set tnow = printer["temperature_sensor chamber"].temperature|float %}
            {% set tnow1 = ((tnow * 10)|int) / 10.0 %}
            _LOG MSG="HEATSOAK: TIMEOUT at chamber={tnow1}C; continuing" DISPLAY=1
        {% endif %}
    {% endif %}

######################################################################
# START / END PRINT (simple)
######################################################################

[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    {% set CHAMBER = params.CHAMBER|default(printer["gcode_macro _NEVERMORE_VARS"].target_c)|float %}
    {% set TIMEOUT = params.TIMEOUT|default(1800)|int %}
    {% set thr = printer["gcode_macro _NEVERMORE_VARS"].threshold_bed|float %}

    {% if printer["gcode_macro ENC_HEATING"] is defined %} ENC_HEATING {% endif %}
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}

    M140 S{BED_TEMP}
    M104 S150
    M190 S{BED_TEMP}

    {% if BED_TEMP >= thr %}
        HEATSOAK BED={BED_TEMP} CHAMBER={CHAMBER} TIMEOUT={TIMEOUT} STEP=10
    {% else %}
        NEVERMORE_OFF
    {% endif %}

    {% if printer["gcode_macro status_homing"] is defined %} STATUS_HOMING {% endif %}
    G90
    M83
    G28


    {% if printer["gcode_macro status_leveling"] is defined %} STATUS_LEVELING {% endif %}
    Z_TILT_ADJUST

    {% if printer["gcode_macro status_meshing"] is defined %} STATUS_MESHING {% endif %}
    BED_MESH_CALIBRATE ADAPTIVE=1

    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}
    M104 S{EXTRUDER_TEMP}
    M109 S{EXTRUDER_TEMP}

    {% if printer["gcode_macro status_ready"] is defined %} STATUS_READY {% endif %}
    PRIME_LINE

    # keep your exhaust logic (bed-temp based)
    {% if BED_TEMP >= thr %}
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0
    {% else %}
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0.4
    {% endif %}

    {% if printer["gcode_macro ENC_PRINTING"] is defined %} ENC_PRINTING {% endif %}
    {% if printer["gcode_macro status_printing"] is defined %} STATUS_PRINTING {% endif %}

[gcode_macro END_PRINT]
gcode:
    {% if printer["gcode_macro status_off"] is defined %} STATUS_OFF {% endif %}
    {% if printer["gcode_macro ENC_PRESENT"] is defined %} ENC_PRESENT {% endif %}

    {% set PRESENT_Z = params.PRESENT_Z|default(20)|float %}

    G91
    G1 E-2 F2400
    G1 Z5 F1500
    G90

    # Park front-left
    G1 X{printer.toolhead.axis_minimum.x + 5} Y{printer.toolhead.axis_minimum.y + 5} F9000
    {% if printer.toolhead.position.z|float < PRESENT_Z %}
        G1 Z{PRESENT_Z} F1500
    {% endif %}

    M107
    M104 S0
    M140 S0

    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.7
    UPDATE_DELAYED_GCODE ID=EXHAUST_FAN_OFF DURATION=300

    NEVERMORE_OFF
    M84 X Y E

[gcode_macro PRIME_LINE]
gcode:
    G90
    M83
    G1 Z2 F3000
    G1 X5 Y30 F9000
    G1 Z0.25 F3000
    G92 E0
    G1 X5  Y200 F1500 E12
    G1 X8  Y200 F9000
    G1 X8  Y30  F1500 E18
    G92 E0
    G1 Z1 F3000

[delayed_gcode EXHAUST_FAN_OFF]
gcode:
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0
    RESPOND PREFIX="TRACE" MSG="EXHAUST_FAN_OFF: exhaust off"


[gcode_macro TEST_FILAMENT_SWITCHES]
description: Diagnostic - reports entry/toolhead filament switch states (no pause, no errors)
gcode:
    {% set show = params.SHOW|default(0)|int %}

    {% if printer["filament_switch_sensor filament_entry"] is not defined %}
        RESPOND PREFIX="FILAMENT" MSG="Entry sensor not defined (expected: [filament_switch_sensor filament_entry])"
        {% if show %} M117 Entry sensor not defined {% endif %}
    {% else %}
        {% set entry = printer["filament_switch_sensor filament_entry"].filament_detected %}
        {% if entry %}
            RESPOND PREFIX="FILAMENT" MSG="Entry sensor: DETECTED"
            {% if show %} M117 Entry: YES {% endif %}
        {% else %}
            RESPOND PREFIX="FILAMENT" MSG="Entry sensor: OPEN"
            {% if show %} M117 Entry: NO {% endif %}
        {% endif %}
    {% endif %}

    {% if printer["filament_switch_sensor filament_toolhead"] is not defined %}
        RESPOND PREFIX="FILAMENT" MSG="Toolhead sensor not defined (expected: [filament_switch_sensor filament_toolhead])"
        {% if show %} M117 Toolhead sensor not defined {% endif %}
    {% else %}
        {% set th = printer["filament_switch_sensor filament_toolhead"].filament_detected %}
        {% if th %}
            RESPOND PREFIX="FILAMENT" MSG="Toolhead sensor: DETECTED"
            {% if show %} M117 Toolhead: YES {% endif %}
        {% else %}
            RESPOND PREFIX="FILAMENT" MSG="Toolhead sensor: OPEN"
            {% if show %} M117 Toolhead: NO {% endif %}
        {% endif %}
    {% endif %}

    {% if printer["filament_switch_sensor filament_entry"] is defined and printer["filament_switch_sensor filament_toolhead"] is defined %}
        {% if entry and th %}
            RESPOND PREFIX="FILAMENT" MSG="Summary: OK (entry + toolhead detected)"
        {% elif entry and not th %}
            RESPOND PREFIX="FILAMENT" MSG="Summary: entry=YES toolhead=NO"
        {% elif not entry and th %}
            RESPOND PREFIX="FILAMENT" MSG="Summary: entry=NO toolhead=YES"
        {% else %}
            RESPOND PREFIX="FILAMENT" MSG="Summary: both OPEN"
        {% endif %}
    {% endif %}

