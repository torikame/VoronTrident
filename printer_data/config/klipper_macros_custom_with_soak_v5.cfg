######################################################################
# klipper_macros_custom_with_soak_v5.cfg
#
# Notes on logging:
# - M118: "echo" style message to host/console (works, simple).
# - RESPOND: Klipper-native message with PREFIX and TYPE support (recommended).
#
# This file uses RESPOND with PREFIX="TRACE" for easy filtering.
#
# Includes:
#   - _LOG helper (console always, optional display)
#   - CHECK_FILAMENT_PATH (optional; only runs if both sensors exist)
#   - Timed HEATSOAK (no chamber-temp waiting)
#   - START_PRINT / END_PRINT / PRIME_LINE
#   - Enclosure LEDs: heating/printing/present/error + auto ENC_IDLE after 30 min
#
# IMPORTANT INCLUDE ORDER in printer.cfg:
#   [include mainsail.cfg]
#   [include enclosure_leds.cfg]
#   [include klipper_macros_custom_with_soak_v5.cfg]
######################################################################

######################################################################
# LOGGING HELPER
######################################################################

[gcode_macro _LOG]
description: Log to console (always) + optionally to display
gcode:
    {% set MSG = params.MSG|default("")|string %}
    {% set DISPLAY = params.DISPLAY|default(0)|int %}
    RESPOND PREFIX="TRACE" MSG="{MSG}"
    {% if DISPLAY == 1 %}
        M117 {MSG}
    {% endif %}

######################################################################
# AUTO ENC_IDLE AFTER 30 MINUTES
#
# Behavior:
# - Every 30 minutes, this delayed_gcode checks print state.
# - If NOT printing/paused, it sets ENC_IDLE.
# - If printing/paused, it reschedules itself for another 30 minutes.
#
# Also: END_PRINT and CANCEL_PRINT explicitly restart the 30 min timer.
######################################################################

[delayed_gcode ENC_IDLE_TIMER]
initial_duration: 1800
gcode:
    {% set st = printer.print_stats.state|lower %}
    {% if st in ["printing", "paused"] %}
        RESPOND PREFIX="TRACE" MSG="ENC_IDLE_TIMER: printer busy ({st}); rescheduling"
        UPDATE_DELAYED_GCODE ID=ENC_IDLE_TIMER DURATION=1800
    {% else %}
        {% if printer["gcode_macro ENC_IDLE"] is defined %}
            RESPOND PREFIX="TRACE" MSG="ENC_IDLE_TIMER: setting ENC_IDLE (state={st})"
            ENC_IDLE
        {% else %}
            RESPOND PREFIX="TRACE" MSG="ENC_IDLE_TIMER: ENC_IDLE macro not found; skipping"
        {% endif %}
        # Keep checking periodically
        UPDATE_DELAYED_GCODE ID=ENC_IDLE_TIMER DURATION=1800
    {% endif %}

######################################################################
# FILAMENT PATH CHECK (ENTRY + TOOLHEAD)
######################################################################

[gcode_macro CHECK_FILAMENT_PATH]
description: Check filament entry vs toolhead sensors (pause if mismatch)
gcode:
    {% if printer["filament_switch_sensor filament_entry"] is not defined
          or printer["filament_switch_sensor filament_toolhead"] is not defined %}
        _LOG MSG="CHECK_FILAMENT_PATH: sensors not defined, skipping" DISPLAY=0
    {% else %}
        {% set entry = printer["filament_switch_sensor filament_entry"].filament_detected %}
        {% set th    = printer["filament_switch_sensor filament_toolhead"].filament_detected %}

        {% if entry and th %}
            _LOG MSG="Filament OK (entry+toolhead)" DISPLAY=0
        {% elif entry and not th %}
            _LOG MSG="Filament at entry, NOT at toolhead" DISPLAY=1
            PAUSE
        {% elif not entry and th %}
            _LOG MSG="Filament at toolhead, missing at entry (break upstream?)" DISPLAY=1
            PAUSE
        {% else %}
            _LOG MSG="No filament detected" DISPLAY=1
            PAUSE
        {% endif %}
    {% endif %}

######################################################################
# HEATSOAK (TIMED ONLY)
######################################################################

[gcode_macro HEATSOAK]
description: Timed bed-driven heat soak (no chamber-temp waiting)
gcode:
    {% set BED = params.BED|default(110)|float %}
    {% set SOAK = params.SOAK|default(600)|int %}
    {% set HOLD = params.HOLD|default(0)|int %}

    {% if printer["gcode_macro ENC_HEATING"] is defined %} ENC_HEATING {% endif %}
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}

    _LOG MSG="HEATSOAK: heating bed to {BED}C" DISPLAY=0
    M140 S{BED}
    M190 S{BED}

    _LOG MSG="HEATSOAK: timed wait {SOAK}s" DISPLAY=0
    G4 P{SOAK * 1000}

    {% if HOLD > 0 %}
        _LOG MSG="HEATSOAK: hold {HOLD}s" DISPLAY=0
        G4 P{HOLD * 1000}
    {% endif %}

    _LOG MSG="HEATSOAK: complete" DISPLAY=0

######################################################################
# START / END PRINT
######################################################################

[gcode_macro START_PRINT]
description: Start print (heat, optional timed soak for ABS/ASA, home, z-tilt, adaptive mesh, prime, LEDs, exhaust)
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}

    {% set SOAK_BED = params.SOAK_BED|default(BED_TEMP)|float %}
    {% set SOAK_TIME = params.SOAK_TIME|default(600)|int %}
    {% set SOAK_HOLD = params.SOAK_HOLD|default(0)|int %}

    _LOG MSG="START_PRINT: begin (bed={BED_TEMP}C nozzle={EXTRUDER_TEMP}C)" DISPLAY=0

    {% if printer["gcode_macro ENC_HEATING"] is defined %} ENC_HEATING {% endif %}
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}
    _LOG MSG="START_PRINT: heating bed" DISPLAY=0
    M140 S{BED_TEMP}
    M104 S150
    M190 S{BED_TEMP}

    {% if BED_TEMP >= 90 %}
        _LOG MSG="START_PRINT: timed heat soak enabled ({SOAK_TIME}s)" DISPLAY=0
        HEATSOAK BED={SOAK_BED} SOAK={SOAK_TIME} HOLD={SOAK_HOLD}
    {% else %}
        _LOG MSG="START_PRINT: no heat soak (bed < 90C)" DISPLAY=0
    {% endif %}

    {% if printer["gcode_macro status_homing"] is defined %} STATUS_HOMING {% endif %}
    _LOG MSG="START_PRINT: homing" DISPLAY=0
    G90
    M83
    G28

    _LOG MSG="START_PRINT: check filament path" DISPLAY=0
    CHECK_FILAMENT_PATH

    {% if printer["gcode_macro status_leveling"] is defined %} STATUS_LEVELING {% endif %}
    _LOG MSG="START_PRINT: Z_TILT_ADJUST" DISPLAY=0
    Z_TILT_ADJUST

    {% if printer["gcode_macro status_meshing"] is defined %} STATUS_MESHING {% endif %}
    _LOG MSG="START_PRINT: BED_MESH_CALIBRATE (adaptive)" DISPLAY=0
    BED_MESH_CALIBRATE ADAPTIVE=1

    {% if printer["gcode_macro ENC_HEATING"] is defined %} ENC_HEATING {% endif %}
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}
    _LOG MSG="START_PRINT: heating nozzle" DISPLAY=0
    M104 S{EXTRUDER_TEMP}
    M109 S{EXTRUDER_TEMP}

    {% if printer["gcode_macro status_ready"] is defined %} STATUS_READY {% endif %}
    _LOG MSG="START_PRINT: prime line" DISPLAY=0
    PRIME_LINE

    {% if BED_TEMP >= 90 %}
        _LOG MSG="START_PRINT: exhaust OFF (ABS/ASA)" DISPLAY=0
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0
    {% else %}
        _LOG MSG="START_PRINT: exhaust 40% (PLA/PETG)" DISPLAY=0
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0.4
    {% endif %}

    {% if printer["gcode_macro ENC_PRINTING"] is defined %} ENC_PRINTING {% endif %}
    {% if printer["gcode_macro status_printing"] is defined %} STATUS_PRINTING {% endif %}
    _LOG MSG="START_PRINT: printing" DISPLAY=0


[gcode_macro END_PRINT]
description: End print (retract, present Z, park front-left, heaters off, vent chamber)
gcode:
    _LOG MSG="END_PRINT: begin" DISPLAY=0
    {% if printer["gcode_macro status_off"] is defined %} STATUS_OFF {% endif %}
    {% if printer["gcode_macro ENC_PRESENT"] is defined %} ENC_PRESENT {% endif %}

    {% set PRESENT_Z = params.PRESENT_Z|default(20)|float %}
    _LOG MSG="END_PRINT: present_z={PRESENT_Z}" DISPLAY=0

    G91
    G1 E-2 F2400

    {% if "z" in printer.toolhead.homed_axes %}
        G90
        {% set current_z = printer.toolhead.position.z|float %}
        {% if current_z < PRESENT_Z %}
            G1 Z{PRESENT_Z} F1500
        {% endif %}
    {% else %}
        G91
        G1 Z10 F1500
        G90
    {% endif %}

    _LOG MSG="END_PRINT: park front-left" DISPLAY=0
    G90
    G1 X{printer.toolhead.axis_minimum.x + 5} Y{printer.toolhead.axis_minimum.y + 5} F9000

    _LOG MSG="END_PRINT: heaters off" DISPLAY=0
    M107
    M104 S0
    M140 S0

    _LOG MSG="END_PRINT: vent chamber (exhaust 70% for 300s)" DISPLAY=0
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.7
    UPDATE_DELAYED_GCODE ID=EXHAUST_FAN_OFF DURATION=300

    # Start (or restart) the 30-minute idle timer
    UPDATE_DELAYED_GCODE ID=ENC_IDLE_TIMER DURATION=1800

    M84 X Y E
    _LOG MSG="END_PRINT: done" DISPLAY=0


######################################################################
# PRIME LINE
######################################################################

[gcode_macro PRIME_LINE]
description: Simple prime line (adjust positions for your bed size)
gcode:
    _LOG MSG="PRIME_LINE: start" DISPLAY=0
    G90
    M83
    G1 Z2 F3000
    G1 X5 Y30 F9000
    G1 Z0.25 F3000
    G92 E0
    G1 X5  Y200 F1500 E12
    G1 X8  Y200 F9000
    G1 X8  Y30  F1500 E18
    G92 E0
    G1 Z1 F3000
    _LOG MSG="PRIME_LINE: done" DISPLAY=0


######################################################################
# CANCEL_PRINT (WRAPPER)
######################################################################

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
description: Wrapper around Mainsail CANCEL_PRINT (then vent chamber + error LEDs)
gcode:
    _LOG MSG="CANCEL_PRINT: begin" DISPLAY=0
    CANCEL_PRINT_BASE
    {% if printer["gcode_macro status_off"] is defined %} STATUS_OFF {% endif %}
    {% if printer["gcode_macro ENC_ERROR"] is defined %} ENC_ERROR {% endif %}
    _LOG MSG="CANCEL_PRINT: vent chamber (exhaust 70% for 300s)" DISPLAY=0
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.7
    UPDATE_DELAYED_GCODE ID=EXHAUST_FAN_OFF DURATION=300

    # Start (or restart) the 30-minute idle timer
    UPDATE_DELAYED_GCODE ID=ENC_IDLE_TIMER DURATION=1800


######################################################################
# DELAYED EXHAUST OFF
######################################################################

[delayed_gcode EXHAUST_FAN_OFF]
gcode:
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0
    RESPOND PREFIX="TRACE" MSG="EXHAUST_FAN_OFF: exhaust off"
