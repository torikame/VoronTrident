######################################################################
# klipper_macros_custom_with_soak_v3.cfg
# Keeps Mainsail PAUSE/RESUME behavior (does NOT override them).
#
# Provides:
#   - HEATSOAK (timed only; no chamber-temp waiting)
#   - START_PRINT / END_PRINT / PRIME_LINE
#   - Bed-temp-based exhaust behavior during print
#   - Post-print venting for END_PRINT
#   - A light CANCEL_PRINT wrapper that calls Mainsail's CANCEL_PRINT, then vents
#
# IMPORTANT INCLUDE ORDER in printer.cfg:
#   [include mainsail.cfg]
#   [include enclosure_leds.cfg]
#   [include klipper_macros_custom_with_soak_v3.cfg]
######################################################################

######################################################################
# HEATSOAK (TIMED ONLY)
######################################################################

[gcode_macro HEATSOAK]
description: Timed bed-driven heat soak (no chamber-temp waiting)
gcode:
    {% set BED = params.BED|default(110)|float %}
    {% set SOAK = params.SOAK|default(600)|int %}
    {% set HOLD = params.HOLD|default(0)|int %}

    {% if printer["gcode_macro ENC_HEATING"] is defined %} ENC_HEATING {% endif %}
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}

    # Bring bed to soak temp, then wait SOAK seconds
    M140 S{BED}
    M190 S{BED}
    M117 Heat soak: timed ({SOAK}s)...
    G4 P{SOAK * 1000}

    # Optional extra hold (defaults off)
    {% if HOLD > 0 %}
        G4 P{HOLD * 1000}
    {% endif %}
    M117 Heat soak complete


######################################################################
# START / END PRINT
######################################################################

[gcode_macro START_PRINT]
description: Start print (heat, optional timed soak for ABS/ASA, home, z-tilt, adaptive mesh, prime, LEDs, exhaust)
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}

    # Optional soak tuning (used only when BED_TEMP >= 90 by default)
    {% set SOAK_BED = params.SOAK_BED|default(BED_TEMP)|float %}
    {% set SOAK_TIME = params.SOAK_TIME|default(600)|int %}
    {% set SOAK_HOLD = params.SOAK_HOLD|default(0)|int %}

    # ---- Heat (bed first to reduce ooze) ----
    {% if printer["gcode_macro ENC_HEATING"] is defined %} ENC_HEATING {% endif %}
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}
    M140 S{BED_TEMP}
    M104 S150
    M190 S{BED_TEMP}

    # ---- Timed heat soak (only for ABS/ASA-ish bed temps) ----
    {% if BED_TEMP >= 90 %}
        HEATSOAK BED={SOAK_BED} SOAK={SOAK_TIME} HOLD={SOAK_HOLD}
    {% endif %}

    # ---- Home ----
    {% if printer["gcode_macro status_homing"] is defined %} STATUS_HOMING {% endif %}
    G90
    M83
    G28

    # ---- Level / Mesh ----
    {% if printer["gcode_macro status_leveling"] is defined %} STATUS_LEVELING {% endif %}
    Z_TILT_ADJUST
    {% if printer["gcode_macro status_meshing"] is defined %} STATUS_MESHING {% endif %}
    BED_MESH_CALIBRATE ADAPTIVE=1

    # ---- Final hotend heat ----
    {% if printer["gcode_macro ENC_HEATING"] is defined %} ENC_HEATING {% endif %}
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}
    M104 S{EXTRUDER_TEMP}
    M109 S{EXTRUDER_TEMP}

    # ---- Prime ----
    {% if printer["gcode_macro status_ready"] is defined %} STATUS_READY {% endif %}
    PRIME_LINE

    # ---- Exhaust fan (bed-temp based) ----
    {% if BED_TEMP >= 90 %}
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0
    {% else %}
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0.4
    {% endif %}

    # ---- Printing ----
    {% if printer["gcode_macro ENC_PRINTING"] is defined %} ENC_PRINTING {% endif %}
    {% if printer["gcode_macro status_printing"] is defined %} STATUS_PRINTING {% endif %}


[gcode_macro END_PRINT]
description: End print (retract, present Z, park front-left, heaters off, vent chamber)
gcode:
    {% if printer["gcode_macro status_off"] is defined %} STATUS_OFF {% endif %}
    {% if printer["gcode_macro ENC_PRESENT"] is defined %} ENC_PRESENT {% endif %}

    # Present height (override with END_PRINT PRESENT_Z=25)
    {% set PRESENT_Z = params.PRESENT_Z|default(20)|float %}

    G91
    G1 E-2 F2400

    {% if "z" in printer.toolhead.homed_axes %}
        G90
        {% set current_z = printer.toolhead.position.z|float %}
        {% if current_z < PRESENT_Z %}
            G1 Z{PRESENT_Z} F1500
        {% endif %}
    {% else %}
        G91
        G1 Z10 F1500
        G90
    {% endif %}

    # Park front-left (dynamic, safe for any bed size)
    G90
    G1 X{printer.toolhead.axis_minimum.x + 5} Y{printer.toolhead.axis_minimum.y + 5} F9000

    M107
    M104 S0
    M140 S0

    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.7
    UPDATE_DELAYED_GCODE ID=EXHAUST_FAN_OFF DURATION=300

    M84 X Y E


######################################################################
# PRIME LINE
######################################################################

[gcode_macro PRIME_LINE]
description: Simple prime line (adjust positions for your bed size)
gcode:
    G90
    M83
    G1 Z2 F3000
    G1 X5 Y30 F9000
    G1 Z0.25 F3000
    G92 E0
    G1 X5  Y200 F1500 E12
    G1 X8  Y200 F9000
    G1 X8  Y30  F1500 E18
    G92 E0
    G1 Z1 F3000


######################################################################
# CANCEL_PRINT (WRAPPER)
######################################################################

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
description: Wrapper around Mainsail CANCEL_PRINT (then vent chamber + error LEDs)
gcode:
    CANCEL_PRINT_BASE
    {% if printer["gcode_macro status_off"] is defined %} STATUS_OFF {% endif %}
    {% if printer["gcode_macro ENC_ERROR"] is defined %} ENC_ERROR {% endif %}
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.7
    UPDATE_DELAYED_GCODE ID=EXHAUST_FAN_OFF DURATION=300


######################################################################
# DELAYED EXHAUST OFF
######################################################################

[delayed_gcode EXHAUST_FAN_OFF]
gcode:
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0
