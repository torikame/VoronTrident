######################################################################
# klipper_macros_custom.cfg
# Option A: Keep Mainsail PAUSE/RESUME behavior (do NOT override them).
#
# Provides:
#   - START_PRINT / END_PRINT / PRIME_LINE
#   - Bed-temp-based exhaust behavior during print
#   - Post-print venting for END_PRINT
#   - A light CANCEL_PRINT wrapper that calls Mainsail's CANCEL_PRINT, then vents
#
# IMPORTANT INCLUDE ORDER in printer.cfg:
#   [include mainsail.cfg]
#   [include klipper_macros_custom.cfg]   <-- include THIS after mainsail.cfg
######################################################################

[gcode_macro START_PRINT]
description: Start print (heat, home, z-tilt, adaptive mesh, prime, LEDs, exhaust)
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}

    # ---- Heat (bed first to reduce ooze) ----
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}
    M140 S{BED_TEMP}
    M104 S150
    M190 S{BED_TEMP}

    # ---- Home ----
    {% if printer["gcode_macro status_homing"] is defined %} STATUS_HOMING {% endif %}
    G90
    M83
    G28

    # ---- Level / Mesh ----
    {% if printer["gcode_macro status_leveling"] is defined %} STATUS_LEVELING {% endif %}
    Z_TILT_ADJUST
    {% if printer["gcode_macro status_meshing"] is defined %} STATUS_MESHING {% endif %}
    BED_MESH_CALIBRATE ADAPTIVE=1

    # ---- Final hotend heat ----
    {% if printer["gcode_macro status_heating"] is defined %} STATUS_HEATING {% endif %}
    M104 S{EXTRUDER_TEMP}
    M109 S{EXTRUDER_TEMP}

    # ---- Prime ----
    {% if printer["gcode_macro status_ready"] is defined %} STATUS_READY {% endif %}
    PRIME_LINE

    # ---- Exhaust fan (bed-temp based) ----
    # ABS/ASA bed temps are typically >= 90C; keep chamber sealed during print.
    {% if BED_TEMP >= 90 %}
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0
    {% else %}
        # PLA/PETG: gentle exhaust to reduce heat creep / keep temps stable
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0.4
    {% endif %}

    # ---- Printing ----
    {% if printer["gcode_macro status_printing"] is defined %} STATUS_PRINTING {% endif %}


[gcode_macro END_PRINT]
description: End print (retract, present Z, park front-center, heaters off, vent chamber)
gcode:
    {% if printer["gcode_macro status_off"] is defined %} STATUS_OFF {% endif %}

    # Present height (override with END_PRINT PRESENT_Z=25)
    {% set PRESENT_Z = params.PRESENT_Z|default(20)|float %}

    # Retract a bit
    G91
    G1 E-2 F2400

    # Raise Z to at least PRESENT_Z (absolute) if we know where we are
    {% if "z" in printer.toolhead.homed_axes %}
        G90
        {% set current_z = printer.toolhead.position.z|float %}
        {% if current_z < PRESENT_Z %}
            G1 Z{PRESENT_Z} F1500
        {% endif %}
    {% else %}
        # If not homed, do a conservative relative lift
        G91
        G1 Z10 F1500
        G90
    {% endif %}

    # Park front-center (dynamic, safe for any bed size)
    G90
    G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y + 5} F9000

    # Heaters/fans off
    M107
    M104 S0
    M140 S0

    # Vent chamber for 5 minutes after print
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.7
    UPDATE_DELAYED_GCODE ID=EXHAUST_FAN_OFF DURATION=300

    # Motors off (leave Z enabled if you prefer)
    M84 X Y E


[gcode_macro PRIME_LINE]
description: Simple prime line (adjust positions for your bed size)
gcode:
    G90
    M83

    # Lift for travel
    G1 Z2 F3000

    # Prime position (safe margin from edges)
    G1 X5 Y30 F9000

    # Down for priming
    G1 Z0.25 F3000

    # Reset extruder
    G92 E0

    # Two lines
    G1 X5  Y200 F1500 E12
    G1 X8  Y200 F9000
    G1 X8  Y30  F1500 E18

    # Reset extruder
    G92 E0

    # Lift a touch
    G1 Z1 F3000


[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
description: Wrapper around Mainsail CANCEL_PRINT (then vent chamber)
gcode:
    # Run Mainsail's cancel first (parks, state cleanup, etc.)
    CANCEL_PRINT_BASE

    {% if printer["gcode_macro status_off"] is defined %} STATUS_OFF {% endif %}

    # Vent chamber for 5 minutes after cancel
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.7
    UPDATE_DELAYED_GCODE ID=EXHAUST_FAN_OFF DURATION=300


[delayed_gcode EXHAUST_FAN_OFF]
gcode:
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0
