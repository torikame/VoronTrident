# This file contains common pin mappings for the BigTreeTech SKR 2.
# To use this config, the firmware should be compiled for the
# STM32F407 with a "32KiB bootloader".

# In newer versions of this board shipped in late 2021 the STM32F429
# is used, if this is the case compile for this with a "32KiB bootloader"
# You will need to check the chip on your board to identify which you have.
#
# The "make flash" command does not work on the SKR 2. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR 2
# with that SD card.

# See docs/Config_Reference.md for a description of parameters.

# Note: The initial revision of this board has a flaw that can cause
# damage to itself and other boards. Be sure to verify the board is
# not impacted by this flaw before using it.


[include mainsail.cfg]
[include klipper_macros.cfg]
[include mcu_ebb36.cfg]
[include mcu_eddy.cfg]
[include bed_config.cfg]
[include stealthburner_leds.cfg]
[include orbitersensor_config.cfg]

######################################
# Printer Settings
######################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_350033001550305031353020-if00

[printer]
kinematics: corexy
max_velocity: 350  
max_accel: 3000
max_z_velocity: 50
max_z_accel: 350
square_corner_velocity: 10.0

#[temperature_sensor MCU]
#sensor_type: temperature_mcu

[temperature_sensor SoC]
sensor_type: temperature_host

#[fan_generic mcufan]
[temperature_fan controller_fan2]
pin: PB7
sensor_type: temperature_mcu
sensor_mcu: mcu
control: watermark
max_power: 0.5
min_temp: 10
max_temp: 65
target_temp: 40
shutdown_speed: 0


######################################
# Top Steppers
######################################

[stepper_x]
step_pin: PE2
dir_pin: PE1
enable_pin: !PE3
microsteps: 16
rotation_distance: 40
endstop_pin: EBBCan: PB6
position_endstop: 350
position_max: 350
homing_speed: 25
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PE0
run_current: 0.800
stealthchop_threshold: 0
#diag_pin:

[stepper_y]
step_pin: PD5
dir_pin: !PD4
enable_pin: !PD6
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC3
position_endstop: 350
position_max: 350
homing_speed: 25

[tmc2209 stepper_y]
uart_pin: PD3
run_current: 0.800
stealthchop_threshold: 0
#diag_pin:

######################################
# Z Bed Steppers
######################################


[stepper_z]
step_pin: PA15
dir_pin: !PA8
enable_pin: !PD1
microsteps: 32
rotation_distance: 4
endstop_pin: ^PC0
#position_endstop: 0.5
position_max: 250
position_min: -2.5
homing_speed : 8.0
second_homing_speed: 3
homing_retract_dist: 3

[tmc2209 stepper_z]
uart_pin: PD0
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: PD15
dir_pin: !PD14
enable_pin: !PC7
microsteps: 32
rotation_distance: 4

[tmc2209 stepper_z1]
uart_pin: PC6
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PD11
dir_pin: !PD10
enable_pin: !PD13
microsteps: 32
rotation_distance: 4

[tmc2209 stepper_z2]
uart_pin: PD12
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

######################################
# Heated Bed
######################################

[heater_bed]
heater_pin: PD7
sensor_type: Generic 3950
sensor_pin: PA1
#control: watermark
min_temp: 0
max_temp: 130

######################################
# RGB
######################################

[neopixel enclosure]
pin: PE6
chain_count: 50
color_order: GRB
initial_RED: 0.7
initial_GREEN: 0.7
initial_BLUE: 0.7



#[heater_fan fan1]
#pin: PB6

#[heater_fan fan2]
#pin: PB5

# Due to BTT implementing a Marlin-specific safety feature,
# "anti-reversal stepper protection", this pin needs pulling
# high to pass power to stepper drivers and most FETs

[output_pin motor_power]
pin: PC13
value: 1

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC5, EXP1_3=PB1, EXP1_5=PE10, EXP1_7=PE12, EXP1_9=<GND>,
    EXP1_2=PB0, EXP1_4=PE9, EXP1_6=PE11, EXP1_8=PE13, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PA6, EXP2_3=PE7, EXP2_5=PB2, EXP2_7=PC4,   EXP2_9=<GND>,
    EXP2_2=PA5, EXP2_4=PA4, EXP2_6=PA7, EXP2_8=<RST>, EXP2_10=<NC>

#####################################################################
#   Exclude Object
#####################################################################

[exclude_object]

# See the sample-lcd.cfg file for definitions of common LCD displays.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3259541.929,0.090000:3258608.027,0.130000:3257668.834,
#*# 	0.170000:3256777.953,0.210000:3255889.675,0.250000:3254980.177,
#*# 	0.290000:3254147.129,0.330000:3253281.502,0.370000:3252434.265,
#*# 	0.410000:3251675.470,0.450000:3250863.061,0.490000:3250027.884,
#*# 	0.530000:3249288.166,0.570000:3248534.628,0.610000:3247798.896,
#*# 	0.650000:3247090.176,0.690000:3246350.867,0.730000:3245634.338,
#*# 	0.770000:3244951.103,0.810000:3244261.420,0.850000:3243590.088,
#*# 	0.890000:3242929.606,0.930000:3242306.892,0.970000:3241639.486,
#*# 	1.010000:3241037.292,1.050000:3240430.873,1.090000:3239822.792,
#*# 	1.130000:3239235.125,1.170000:3238646.288,1.210000:3238104.690,
#*# 	1.250000:3237519.904,1.290000:3236994.324,1.330000:3236454.336,
#*# 	1.370000:3235932.774,1.410000:3235383.596,1.450000:3234880.490,
#*# 	1.490000:3234368.547,1.530000:3233902.014,1.570000:3233409.209,
#*# 	1.610000:3232932.458,1.650000:3232487.508,1.690000:3232004.540,
#*# 	1.730000:3231554.655,1.770000:3231117.670,1.810000:3230657.944,
#*# 	1.850000:3230253.108,1.890000:3229832.017,1.930000:3229422.285,
#*# 	1.970000:3229017.411,2.010000:3228631.373,2.050000:3228209.891,
#*# 	2.090000:3227837.868,2.130000:3227458.166,2.170000:3227101.232,
#*# 	2.210000:3226709.643,2.250000:3226370.227,2.290000:3226019.572,
#*# 	2.330000:3225672.757,2.370000:3225320.997,2.410000:3224984.160,
#*# 	2.450000:3224671.735,2.490000:3224351.177,2.530000:3224015.885,
#*# 	2.570000:3223715.785,2.610000:3223402.524,2.650000:3223084.840,
#*# 	2.690000:3222773.157,2.730000:3222519.141,2.770000:3222249.238,
#*# 	2.810000:3221964.748,2.850000:3221672.644,2.890000:3221415.592,
#*# 	2.930000:3221139.393,2.970000:3220865.984,3.010000:3220596.349,
#*# 	3.050000:3220343.066,3.090000:3220119.726,3.130000:3219841.868,
#*# 	3.170000:3219620.587,3.210000:3219371.776,3.250000:3219149.385,
#*# 	3.290000:3218921.740,3.330000:3218700.641,3.370000:3218457.110,
#*# 	3.410000:3218248.518,3.450000:3218041.522,3.490000:3217804.828,
#*# 	3.530000:3217595.296,3.570000:3217398.226,3.610000:3217219.042,
#*# 	3.650000:3216991.447,3.690000:3216801.140,3.730000:3216630.596,
#*# 	3.770000:3216414.357,3.810000:3216239.985,3.850000:3216059.636,
#*# 	3.890000:3215875.098,3.930000:3215699.946,3.970000:3215526.180,
#*# 	4.010000:3215370.133,4.050000:3215165.503
#*# z_offset = 2.470
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 53.369387
#*# drift_calibration =
#*# 	3292852.222415, -1000.295783, 6.979293
#*# 	3273561.647036, -719.465309, 4.780027
#*# 	3257972.579503, -491.380420, 3.010325
#*# 	3245645.251141, -314.960085, 1.650939
#*# 	3236378.199664, -192.703421, 0.706205
#*# 	3228484.896789, -77.229196, -0.216628
#*# 	3222937.495515, -14.899012, -0.679640
#*# 	3217792.144725, 61.377602, -1.304182
#*# 	3214355.049107, 93.859591, -1.526999
#*# drift_calibration_min_temp = 42.196960419404434
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.017087, 0.031769, 0.035202, 0.047875, 0.045503, 0.055441, 0.059342, 0.069438, 0.068248, 0.078667, 0.080775, 0.075627, 0.079295, 0.077770, 0.079718, 0.074732, 0.071344, 0.066987, 0.063527, 0.056082, 0.048640, 0.041194, 0.031261, 0.032963, 0.015706
#*# 	0.005566, 0.009655, 0.024413, 0.023921, 0.030535, 0.036337, 0.040114, 0.047322, 0.048272, 0.062533, 0.062173, 0.062063, 0.064185, 0.067851, 0.068555, 0.070038, 0.064842, 0.060584, 0.054325, 0.047229, 0.044712, 0.024101, 0.019635, 0.010586, 0.010044
#*# 	-0.004126, -0.000527, 0.004301, 0.014253, 0.025165, 0.028014, 0.024789, 0.035211, 0.043182, 0.050267, 0.051809, 0.064927, 0.062487, 0.067970, 0.062182, 0.060997, 0.058874, 0.046458, 0.042323, 0.032586, 0.026504, 0.026619, 0.011992, 0.000476, -0.001364
#*# 	-0.009319, -0.009930, 0.001216, 0.008473, 0.015915, 0.022191, 0.032770, 0.033596, 0.037167, 0.043076, 0.041189, 0.052778, 0.053953, 0.061404, 0.054960, 0.062638, 0.054134, 0.040658, 0.038770, 0.030891, 0.022990, 0.020389, 0.008121, -0.006015, -0.011846
#*# 	-0.016996, -0.006743, -0.003651, 0.003661, 0.009944, 0.025811, 0.029279, 0.030616, 0.030383, 0.039438, 0.040154, 0.049647, 0.050558, 0.059887, 0.054099, 0.051216, 0.043651, 0.037740, 0.036569, 0.024864, 0.016929, 0.007884, -0.005874, -0.014490, -0.013906
#*# 	-0.025447, -0.014333, -0.015231, -0.004963, 0.000124, 0.023172, 0.023548, 0.021646, 0.031703, 0.030044, 0.035009, 0.033120, 0.043845, 0.041240, 0.038873, 0.041597, 0.035453, 0.031553, 0.017578, 0.014978, 0.008289, -0.004733, -0.013446, -0.026161, -0.032066
#*# 	-0.033630, -0.023860, -0.019546, -0.016594, -0.009659, 0.012275, 0.019597, 0.015263, 0.021332, 0.026664, 0.029525, 0.028773, 0.034997, 0.020104, 0.023572, 0.026217, 0.020681, 0.010844, 0.006018, 0.003172, -0.009812, -0.021168, -0.035476, -0.044691, -0.045064
#*# 	-0.034729, -0.032470, -0.027138, -0.025085, -0.019757, -0.008158, -0.002714, 0.008440, 0.011906, 0.021338, 0.019358, 0.014274, 0.012049, 0.015608, 0.014610, 0.009277, 0.015475, 0.008168, 0.000577, -0.014602, -0.016310, -0.029703, -0.043887, -0.052659, -0.058197
#*# 	-0.039064, -0.034061, -0.022499, -0.028401, -0.016822, -0.015236, -0.008539, -0.002718, 0.002238, 0.009792, 0.009646, 0.015352, 0.012247, 0.008044, 0.017096, 0.010408, 0.000743, -0.002103, -0.014000, -0.014739, -0.026196, -0.037429, -0.046973, -0.058813, -0.067997
#*# 	-0.039007, -0.038659, -0.028343, -0.028189, -0.026154, -0.022980, -0.018995, -0.012990, -0.009336, -0.003517, 0.005035, 0.002305, 0.008012, 0.007073, 0.003853, 0.010788, 0.001121, -0.004700, -0.021856, -0.027307, -0.033777, -0.046254, -0.060794, -0.074158, -0.078512
#*# 	-0.053910, -0.042397, -0.044209, -0.029579, -0.026161, -0.029476, -0.020319, -0.010571, -0.005179, -0.006044, -0.001400, -0.003885, 0.000052, 0.004553, 0.007398, 0.003914, -0.007479, -0.015855, -0.023911, -0.040426, -0.054566, -0.063693, -0.074613, -0.082191, -0.089126
#*# 	-0.044404, -0.047924, -0.036862, -0.036173, -0.035726, -0.026082, -0.017693, -0.011244, -0.020211, -0.016229, -0.013968, -0.011691, -0.012300, -0.004691, -0.009797, -0.013437, -0.024667, -0.024105, -0.037958, -0.045789, -0.063147, -0.076867, -0.086370, -0.101291, -0.106955
#*# 	-0.046338, -0.037495, -0.036704, -0.032167, -0.032841, -0.022748, -0.012485, -0.018832, -0.022471, -0.022696, -0.017246, -0.013522, -0.017713, -0.019524, -0.013971, -0.021231, -0.022767, -0.036031, -0.044878, -0.058623, -0.074426, -0.081421, -0.085681, -0.102376, -0.107902
#*# 	-0.041434, -0.037545, -0.030852, -0.028697, -0.026092, -0.023471, -0.018963, -0.018963, -0.020326, -0.022931, -0.012272, -0.013937, -0.018127, -0.013817, -0.021300, -0.024025, -0.026709, -0.034314, -0.041231, -0.054098, -0.070293, -0.076290, -0.084250, -0.102109, -0.108020
#*# 	-0.043590, -0.029070, -0.026701, -0.019562, -0.024666, -0.021148, -0.020579, -0.023911, -0.028671, -0.022325, -0.017686, -0.013359, -0.014385, -0.018246, -0.022438, -0.025683, -0.026700, -0.034872, -0.044512, -0.058069, -0.073557, -0.091618, -0.096289, -0.097253, -0.118174
#*# 	-0.037792, -0.034553, -0.028252, -0.025874, -0.026322, -0.031771, -0.031323, -0.029325, -0.029324, -0.027618, -0.017530, -0.017412, -0.024828, -0.026759, -0.029363, -0.025293, -0.033002, -0.035200, -0.050076, -0.073453, -0.086809, -0.101963, -0.111476, -0.121500, -0.128848
#*# 	-0.035791, -0.035755, -0.032479, -0.028169, -0.024996, -0.023185, -0.032182, -0.030361, -0.031388, -0.020044, -0.015855, -0.018382, -0.028469, -0.029607, -0.033723, -0.031763, -0.041917, -0.046796, -0.069127, -0.076193, -0.096207, -0.106369, -0.120940, -0.135111, -0.143677
#*# 	-0.033444, -0.027964, -0.015501, -0.019810, -0.023098, -0.024344, -0.026075, -0.028005, -0.025179, -0.024490, -0.014405, -0.010403, -0.023632, -0.029750, -0.034854, -0.039957, -0.047243, -0.059479, -0.068597, -0.083102, -0.100472, -0.104950, -0.119406, -0.137222, -0.148860
#*# 	-0.025497, -0.011449, -0.009812, -0.017190, -0.016041, -0.017742, -0.020465, -0.009285, -0.014193, -0.014072, -0.007046, -0.009436, -0.019020, -0.024349, -0.033086, -0.035569, -0.049514, -0.059721, -0.072428, -0.084882, -0.092266, -0.110264, -0.125678, -0.127189, -0.137604
#*# 	-0.019068, -0.004852, -0.012405, -0.011956, -0.021487, -0.020785, -0.018976, -0.014771, -0.011841, -0.013186, -0.010318, -0.007276, -0.019279, -0.026519, -0.028345, -0.036238, -0.055619, -0.060248, -0.079881, -0.087201, -0.101055, -0.113296, -0.124370, -0.130979, -0.147030
#*# 	-0.019553, -0.015208, -0.015620, -0.024009, -0.020154, -0.019930, -0.019929, -0.016236, -0.010789, -0.012150, -0.015437, -0.018045, -0.020423, -0.026914, -0.031447, -0.041200, -0.056494, -0.070145, -0.077600, -0.096587, -0.112191, -0.123376, -0.137552, -0.145803, -0.150743
#*# 	-0.015756, -0.015292, -0.013706, -0.015069, -0.016549, -0.021050, -0.015276, -0.015157, -0.013450, -0.005961, -0.015367, -0.015246, -0.020004, -0.029982, -0.037718, -0.045422, -0.059363, -0.071679, -0.085030, -0.104363, -0.111523, -0.121966, -0.142052, -0.156104, -0.156501
#*# 	-0.007257, -0.012689, 0.000156, -0.000912, -0.003884, -0.004994, -0.011295, -0.003998, -0.008250, -0.006350, -0.001646, -0.007461, -0.016617, -0.017515, -0.032535, -0.037671, -0.052063, -0.068221, -0.085033, -0.102356, -0.113426, -0.129388, -0.146263, -0.150840, -0.165569
#*# 	0.012221, 0.003362, 0.005713, 0.004717, 0.005110, -0.002135, 0.001963, -0.003115, -0.002738, 0.000480, 0.000106, -0.000923, -0.006116, -0.012215, -0.028634, -0.035994, -0.045746, -0.068527, -0.085247, -0.094018, -0.113879, -0.129107, -0.136952, -0.162230, -0.165977
#*# 	-0.011153, -0.014097, -0.005584, -0.012968, -0.017948, -0.014657, -0.016363, -0.019038, -0.024606, -0.024847, -0.021557, -0.022574, -0.026760, -0.035622, -0.047059, -0.056565, -0.078260, -0.090373, -0.106468, -0.123442, -0.139035, -0.157131, -0.179520, -0.191345, -0.205726
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 319.92
#*# min_y = 30.0
#*# max_y = 319.92
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 57.205
#*# pid_ki = 2.119
#*# pid_kd = 386.131
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 63.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 40.0
#*#
#*# [stepper_z]
#*# position_endstop = 0.579
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.096
#*# pid_ki = 3.115
#*# pid_kd = 58.932
